name: Build all
on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - '**/README.md'
  schedule:
      # Every Saturday at 2AM UTC
    - cron: "0 2 * * 6"

env:
  DNF_CACHE_PATH: /var/cache/libdnf5 # F41+ and newer F40 with libdnf5
  HOST_DNF_CACHE_PATH: /tmp/libdnf5 # Any path is okay
  DNF_CACHE_PURGE_THRESHOLD_MB: 400
  FEDORA_VERSION: "41"

jobs:
  build-and-push:
    strategy:
      matrix:
        job:
          - { name: amd64, os: ubuntu-latest, pretty-name: Build and push amd64 image }
          - { name: arm64, os: ubuntu-24.04-arm, pretty-name: Build and push arm64 image }
    runs-on: ${{ matrix.job.os }}
    name: ${{ matrix.job.pretty-name }}
    permissions:
      contents: read
      packages: write
      id-token: write # needed for signing the images with GitHub OIDC Token
      attestations: write

    steps:
      - name: Check out the repository
        uses: actions/checkout@v4

      - name: Install Podman and buildah on arm64
        if: contains( matrix.job.name , 'arm64')
        run: |
          sudo apt-get update
          sudo apt-get install podman buildah -y

      - name: Mkdir for DNF Cache
        run: mkdir -p ${{ env.HOST_DNF_CACHE_PATH }}

      - name: Restore DNF Cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.HOST_DNF_CACHE_PATH }}
          key: dnf-cache-${{ matrix.job.name }}
      
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.7.0

      - name: Extract metadata for Docker (main)
        id: meta-main
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          flavor: |
            latest=false
          tags: |
             type=raw,value={{date 'YYYYMMDD'}}-${{ matrix.job.name }}
             type=raw,value=latest-${{ matrix.job.name }}

      - name: Log in to ghcr.io (Using Action)
        uses: redhat-actions/podman-login@v1
        #if: false
        with:
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: ghcr.io

      # https://github.com/ublue-os/bluefin/blob/36c6eef3a61ebfb41edf9e4d1a4c86648c977506/.github/workflows/reusable-build.yml#L149-L153
      - name: Log in to ghcr.io (Using command) 
        if: false
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | podman login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Buildah Action (main)
        id: build-image-main
        uses: redhat-actions/buildah-build@v2
        with:
          context: fe
          containerfiles: fe/Dockerfile.${{ env.FEDORA_VERSION }}
          tags: ${{ steps.meta-main.outputs.tags }}
          oci: true
          extra-args: |
            --squash
            -v ${{ env.HOST_DNF_CACHE_PATH }}:${{ env.DNF_CACHE_PATH }}

      - name: Purge dnf5 cache if too big
        run: |
          # Folder size (KB)
          folder_size=$(du -sk ${{ env.HOST_DNF_CACHE_PATH }} | cut -f1)
          echo "Folder size: ${folder_size} KB; $(($folder_size /1024)) MB"
  
          # 100MB = 100 * 1024 KB
          threshold=$((${{ env.DNF_CACHE_PURGE_THRESHOLD_MB }} * 1024))
          echo "Threshold size: ${threshold} KB; ${{ env.DNF_CACHE_PURGE_THRESHOLD_MB }} MB"

          if [ "$folder_size" -gt "$threshold" ]; then
            echo "Threshold size exceed, purging."
            rm -rf ${{ env.HOST_DNF_CACHE_PATH }}/*
            echo '### DNF Cache purging: true' >> $GITHUB_STEP_SUMMARY
          else
            echo "Threshold size is not exceed."
            echo '* ### DNF Cache purging: false' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Get Date for creating cache key
        id: get-date
        shell: bash
        run: |
          echo "date=$(/bin/date -u "+%Y%m%d")" >> $GITHUB_OUTPUT

      - name: Save DNF Cache
        uses: actions/cache/save@v4
        with:
          path: ${{ env.HOST_DNF_CACHE_PATH }}
          key: dnf-cache-${{ matrix.job.name }}-${{ steps.get-date.outputs.date }}

      - name: Push (main)
        id: push-main
        uses: redhat-actions/push-to-registry@v2
        with:
          image: ${{ steps.build-image-main.outputs.image }}
          tags: ${{ steps.build-image-main.outputs.tags }}
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          extra-args: |
            --compression-format=zstd

      - name: Sign the images with GitHub OIDC Token (main)
        if: false
        env:
          DIGEST: ${{ steps.push-main.outputs.digest }}
          TAGS: ${{ steps.meta-main.outputs.tags }}
        run: |
          images=""
          for tag in ${TAGS}; do
            images+="${tag}@${DIGEST} "
          done
          cosign sign --yes ${images}

      - name: Attest (main)
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ghcr.io/${{ github.repository }}
          subject-digest: ${{ steps.push-main.outputs.digest }}
          push-to-registry: true

  link-container-tags:
    runs-on: ubuntu-24.04-arm
    name: Link Container tags
    needs: build-and-push
    permissions:
      contents: read
      packages: write
      id-token: write # needed for signing the images with GitHub OIDC Token
      attestations: write
    steps:
      - name: Login ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifest (latest)
        id: manifest-latest
        uses: Noelware/docker-manifest-action@58feea6e97f7edb454571f323baeb10cb1507b2b
        with:
          base-image: ghcr.io/${{ github.repository }}:latest
          extra-images: |
            ghcr.io/${{ github.repository }}:latest-amd64,
            ghcr.io/${{ github.repository }}:latest-arm64
          push: true

      - name: Get Date
        id: get-date
        shell: bash
        run: |
          echo "date=$(/bin/date -u "+%Y%m%d")" >> $GITHUB_OUTPUT

      - name: Create and push manifest (time)
        id: manifest-time
        uses: Noelware/docker-manifest-action@58feea6e97f7edb454571f323baeb10cb1507b2b
        with:
          base-image: ghcr.io/${{ github.repository }}:${{ steps.get-date.outputs.date }}
          extra-images: |
            ghcr.io/${{ github.repository }}:${{ steps.get-date.outputs.date }}-amd64,
            ghcr.io/${{ github.repository }}:${{ steps.get-date.outputs.date }}-arm64
          push: true

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.7.0

      - name: "Image:Digest -> Digest"
        id: get-digest-only
        shell: bash
        run: |
          echo "digest-latest=$(echo '${{ steps.manifest-latest.outputs.images }}' | awk -F'@' '{print $2}')" >> $GITHUB_OUTPUT
          echo "digest-time=$(echo '${{ steps.manifest-time.outputs.images }}' | awk -F'@' '{print $2}')" >> $GITHUB_OUTPUT

      - name: Attest (Tag resign) (latest)
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ghcr.io/${{ github.repository }}
          subject-digest: ${{ steps.get-digest-only.outputs.digest-latest }}
          push-to-registry: true

      - name: Sign the images with GitHub OIDC Token (recursive)
        env:
          IMAGES: ${{ steps.manifest-time.outputs.images }}
        run: |
          cosign sign --yes --recursive ${IMAGES}

      - name: Attest (Tag resign) (time)
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ghcr.io/${{ github.repository }}
          subject-digest: ${{ steps.get-digest-only.outputs.digest-time }}
          push-to-registry: true
